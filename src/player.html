<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oopz Music Player</title>
<link rel="icon" href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/icon/03CNSoft/wyy.png" type="image/png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,::before,::after{margin:0;padding:0;box-sizing:border-box;border-width:0;border-style:solid}
::selection{background:rgba(167,139,250,.3);color:#fff}
:root{
  --bg:#09090b;
  --surface:rgba(255,255,255,.03);
  --surface-hover:rgba(255,255,255,.06);
  --surface-active:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.06);
  --border-light:rgba(255,255,255,.1);
  --primary:#a78bfa;
  --primary-light:#c4b5fd;
  --primary-dim:rgba(167,139,250,.4);
  --primary-bg:rgba(167,139,250,.1);
  --primary-border:rgba(167,139,250,.2);
  --primary-glow:rgba(167,139,250,.25);
  --text:#fafafa;
  --text-secondary:rgba(255,255,255,.65);
  --text-muted:rgba(255,255,255,.4);
  --text-dim:rgba(255,255,255,.2);
  --text-ghost:rgba(255,255,255,.08);
  --green:#4ade80;
  --red:#f87171;
  --radius:1rem;
  --radius-lg:1.25rem;
  --radius-xl:1.5rem;
  --ease-out:cubic-bezier(.2,.6,.35,1);
  --ease-spring:cubic-bezier(.34,1.56,.64,1);
  --ease-smooth:cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;font-family:'Inter','PingFang SC','Microsoft YaHei',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
img{display:block;max-width:100%;height:auto}
button{cursor:pointer;font:inherit;color:inherit;background:none;border:none;outline:none;-webkit-tap-highlight-color:transparent}
button:disabled{cursor:default;opacity:.35;pointer-events:none}

/* ===== Noise Texture Overlay ===== */
body::after{
  content:'';position:fixed;inset:0;z-index:999;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:.03;pointer-events:none;mix-blend-mode:overlay;
}

/* ===== Ambient Background ===== */
.ambient{position:fixed;inset:0;z-index:0;opacity:0;transition:opacity 1.5s var(--ease-smooth);pointer-events:none}
.ambient.visible{opacity:.3}
.ambient img{
  position:absolute;inset:-10%;width:120%;height:120%;
  object-fit:cover;filter:blur(80px) saturate(1.8);
  animation:ambientDrift 20s ease-in-out infinite alternate;
}
.ambient .overlay{
  position:absolute;inset:0;
  background:
    radial-gradient(ellipse 80% 60% at 50% 40%, transparent 0%, var(--bg) 100%),
    linear-gradient(to bottom, var(--bg) 0%, transparent 20%, transparent 80%, var(--bg) 100%);
}
@keyframes ambientDrift{
  0%{transform:scale(1.1) translate(0,0)}
  33%{transform:scale(1.15) translate(2%,-1%)}
  66%{transform:scale(1.1) translate(-1%,2%)}
  100%{transform:scale(1.15) translate(1%,-2%)}
}

/* ===== Page Entrance ===== */
@keyframes panelSlideUp{
  from{opacity:0;transform:translateY(24px)}
  to{opacity:1;transform:translateY(0)}
}
@keyframes panelFadeIn{
  from{opacity:0;transform:scale(.97)}
  to{opacity:1;transform:scale(1)}
}

/* ===== Header ===== */
.header{
  position:relative;z-index:10;
  display:flex;align-items:center;justify-content:space-between;
  padding:.625rem 1.25rem;
  background:rgba(9,9,11,.8);
  backdrop-filter:blur(20px) saturate(1.2);-webkit-backdrop-filter:blur(20px) saturate(1.2);
  border-bottom:1px solid var(--border);
  animation:panelSlideUp .6s var(--ease-out) both;
}
.header-left{display:flex;align-items:center;gap:.625rem}
.header-left svg{width:1.25rem;height:1.25rem;color:var(--primary)}
.header-left h1{font-size:1rem;font-weight:700;letter-spacing:-.03em;background:linear-gradient(135deg,var(--text),var(--primary-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-left span{font-size:.8125rem;color:var(--text-muted);font-weight:400}
.header-right{display:flex;align-items:center;gap:.5rem}
.conn-status{display:flex;align-items:center;gap:.375rem;font-size:.8125rem;padding:.25rem .625rem;border-radius:9999px;background:rgba(255,255,255,.04);border:1px solid var(--border)}
.conn-status svg{width:.875rem;height:.875rem}
.conn-status.ok svg{color:var(--green)}
.conn-status.err svg{color:var(--red)}
.conn-status span{color:var(--text-muted);font-weight:500}
.header-btn{
  width:2rem;height:2rem;display:grid;place-items:center;
  border-radius:.5rem;
  transition:all .2s var(--ease-out);
}
.header-btn:hover{background:rgba(255,255,255,.08);transform:scale(1.05)}
.header-btn:active{transform:scale(.95)}
.header-btn svg{width:1rem;height:1rem;color:var(--text-muted);transition:color .2s}
.header-btn:hover svg{color:var(--text)}

/* ===== Main Layout ===== */
.main{
  position:relative;z-index:10;
  height:calc(100vh - 49px);
  display:grid;
  grid-template-columns:minmax(240px,2.5fr) 4.5fr minmax(220px,2.5fr);
  gap:1rem;
  padding:1rem;
  overflow:hidden;
}

/* ===== Shared Panel Glass ===== */
.glass-panel{
  background:rgba(255,255,255,.025);
  border-radius:var(--radius-xl);
  backdrop-filter:blur(16px) saturate(1.1);-webkit-backdrop-filter:blur(16px) saturate(1.1);
  border:1px solid var(--border);
  box-shadow:0 4px 24px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.03);
}

/* ===== Left Panel ===== */
.panel-left{
  display:flex;flex-direction:column;gap:1rem;height:100%;overflow:hidden;
  animation:panelSlideUp .7s .1s var(--ease-out) both;
}

/* Player Card */
.player-card{flex:0 0 auto}
.player-card .inner{display:flex;flex-direction:column;gap:1rem}

/* Album Art */
.album-art{
  position:relative;aspect-ratio:1;border-radius:var(--radius-lg);overflow:hidden;
  background:var(--surface);
  box-shadow:0 0 0 1px rgba(255,255,255,.05), 0 8px 40px rgba(0,0,0,.4);
  transition:box-shadow 1s var(--ease-smooth);
}
.album-art.has-glow{
  box-shadow:0 0 0 1px rgba(255,255,255,.05), 0 0 60px var(--primary-glow), 0 12px 48px rgba(0,0,0,.5);
}
.album-art img{
  width:100%;height:100%;object-fit:cover;
  transition:transform .8s var(--ease-out), opacity .5s;
}
.album-art:hover img{transform:scale(1.04)}

/* Song change crossfade */
.album-art img.art-enter{animation:artFadeIn .6s var(--ease-out) both}
@keyframes artFadeIn{from{opacity:0;transform:scale(1.08)}to{opacity:1;transform:scale(1)}}

.album-art .playing-badge{
  position:absolute;bottom:.625rem;right:.625rem;
  display:flex;align-items:center;gap:.3rem;
  padding:.2rem .5rem;border-radius:9999px;
  background:rgba(0,0,0,.65);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.08);
  transition:all .3s var(--ease-out);
}
.album-art .playing-badge svg{width:.875rem;height:.875rem;color:var(--primary);animation:spin 3s linear infinite}
.album-art .playing-badge span{font-size:.6875rem;font-weight:600;color:rgba(255,255,255,.85);letter-spacing:.02em}
@keyframes spin{to{transform:rotate(360deg)}}
.album-art .playing-badge.paused svg{animation-play-state:paused;color:var(--text-muted)}

/* Song Info */
.song-info{display:flex;flex-direction:column;gap:.125rem}
.song-info h1{font-size:1.125rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4;letter-spacing:-.02em}
.song-info .artist{font-size:.8125rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
.song-info .album-name{font-size:.75rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Song info entrance animation */
.song-info.song-enter h1,
.song-info.song-enter .artist,
.song-info.song-enter .album-name{animation:songTextIn .5s var(--ease-out) both}
.song-info.song-enter .artist{animation-delay:.06s}
.song-info.song-enter .album-name{animation-delay:.12s}
@keyframes songTextIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}

.platform-row{display:flex;align-items:center;gap:.375rem;flex-wrap:wrap}
.platform-badge{
  padding:.125rem .4rem;border-radius:.25rem;
  font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;
  background:var(--primary-bg);color:var(--primary-light);border:1px solid var(--primary-border);
}
.mode-badge{
  padding:.125rem .4rem;border-radius:.25rem;
  font-size:9px;font-weight:500;
  background:rgba(255,255,255,.04);color:var(--text-muted);border:1px solid var(--text-ghost);
}

/* Progress */
.progress-wrap{display:flex;flex-direction:column;gap:.375rem}
.progress-track{
  position:relative;height:1.25rem;cursor:pointer;
  -webkit-user-select:none;user-select:none;touch-action:none;
}
.progress-track .rail{
  position:absolute;top:50%;left:0;right:0;height:.3rem;
  transform:translateY(-50%);border-radius:9999px;overflow:hidden;
  background:rgba(255,255,255,.08);
  transition:height .15s var(--ease-out);
}
.progress-track:hover .rail{height:.375rem}
.progress-track .fill{
  position:absolute;top:0;left:0;height:100%;
  background:linear-gradient(90deg,var(--primary),var(--primary-light));
  transition:width .3s linear;
  box-shadow:0 0 12px var(--primary-glow);
}
.progress-track .thumb{
  position:absolute;top:50%;width:.875rem;height:.875rem;
  background:#fff;border-radius:50%;
  box-shadow:0 0 0 3px rgba(167,139,250,.3), 0 2px 8px rgba(0,0,0,.4);
  opacity:0;transition:opacity .2s, transform .15s var(--ease-spring);
  transform:translate(-50%,-50%) scale(.8);
}
.progress-track:hover .thumb{opacity:1;transform:translate(-50%,-50%) scale(1)}
.progress-time{display:flex;justify-content:space-between;font-size:.6875rem;font-weight:500;color:var(--text-muted);font-variant-numeric:tabular-nums}

/* Volume */
.volume-row{display:flex;align-items:center;gap:.5rem}
.volume-row svg{width:.875rem;height:.875rem;color:var(--text-muted);flex-shrink:0}
.volume-track{
  flex:1;height:1rem;position:relative;cursor:pointer;
  -webkit-user-select:none;user-select:none;touch-action:none;
}
.volume-track .rail{
  position:absolute;top:50%;left:0;right:0;height:.2rem;
  transform:translateY(-50%);border-radius:9999px;overflow:hidden;
  background:rgba(255,255,255,.08);
  transition:height .15s var(--ease-out);
}
.volume-track:hover .rail{height:.25rem}
.volume-track .fill{height:100%;background:var(--text-muted);transition:width .15s}
.volume-track .thumb{
  position:absolute;top:50%;width:.5rem;height:.5rem;
  background:#fff;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,.3);
  opacity:0;transition:opacity .15s;transform:translate(-50%,-50%);
}
.volume-track:hover .thumb{opacity:1}
.volume-pct{font-size:.6875rem;color:var(--text-muted);font-variant-numeric:tabular-nums;width:2rem;text-align:right;flex-shrink:0}

/* Controls Card */
.controls-card{
  flex:0 0 auto;padding:.75rem;
}
.controls-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.375rem}
.ctrl-btn{
  display:flex;flex-direction:column;align-items:center;gap:.25rem;
  padding:.5rem .25rem;border-radius:.75rem;
  background:rgba(255,255,255,.04);
  transition:all .2s var(--ease-out);
  position:relative;overflow:hidden;
}
.ctrl-btn::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at center,rgba(255,255,255,.15),transparent 70%);
  opacity:0;transition:opacity .3s;
}
.ctrl-btn:hover{background:rgba(255,255,255,.08);transform:translateY(-1px)}
.ctrl-btn:hover::before{opacity:1}
.ctrl-btn:active{transform:translateY(0) scale(.96);transition-duration:.1s}
.ctrl-btn.danger:hover{background:rgba(248,113,113,.1);color:var(--red)}
.ctrl-btn.mode:hover{background:var(--primary-bg);color:var(--primary-light)}
.ctrl-btn svg{width:1.125rem;height:1.125rem;position:relative;z-index:1}
.ctrl-btn span{font-size:.625rem;color:var(--text-muted);font-weight:500;position:relative;z-index:1;white-space:nowrap}

/* Idle State */
.idle-state{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;gap:.75rem;color:var(--text-dim);
  animation:idlePulse 3s ease-in-out infinite;
}
.idle-state svg{width:2.5rem;height:2.5rem;opacity:.3}
.idle-state p{font-size:.8125rem;font-weight:500}
@keyframes idlePulse{0%,100%{opacity:.6}50%{opacity:1}}

/* ===== Center Panel: Lyrics ===== */
.panel-center{
  height:100%;min-height:0;overflow:hidden;
  animation:panelFadeIn .8s .2s var(--ease-out) both;
}
.lyrics-container{height:100%;display:flex;flex-direction:column;position:relative}
.lyrics-controls{
  position:absolute;top:.75rem;right:.75rem;z-index:20;
  display:flex;align-items:center;gap:.375rem;
  flex-wrap:wrap;
}
.lyric-toggle{
  display:flex;align-items:center;gap:.25rem;
  padding:.3rem .6rem;font-size:.6875rem;font-weight:600;
  border-radius:9999px;transition:all .25s var(--ease-out);
  border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--text-muted);
  letter-spacing:.01em;
}
.lyric-toggle:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12);color:var(--text-secondary)}
.lyric-toggle.active{background:var(--primary-bg);color:var(--primary-light);border-color:var(--primary-border)}
.lyric-toggle svg{width:.75rem;height:.75rem}
.lyric-sync-popover{
  position:absolute;top:100%;right:0;margin-top:.35rem;z-index:30;
  padding:.5rem .75rem;border-radius:.5rem;
  background:rgba(18,18,22,.98);border:1px solid var(--border);
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  font-size:.75rem;color:var(--text-secondary);
  display:none;flex-wrap:wrap;align-items:center;gap:.5rem;
}
.lyric-sync-popover.open{display:flex}
.lyric-sync-popover span{font-weight:500;color:var(--text-muted)}
.lyric-sync-popover button{
  padding:.2rem .4rem;border-radius:.25rem;font-size:.6875rem;font-weight:600;
  background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);
  transition:all .15s var(--ease-out);
}
.lyric-sync-popover button:hover{background:rgba(255,255,255,.1);border-color:var(--border-light)}
.lyric-sync-popover button:active{transform:scale(.96)}

.lyrics-scroll{
  flex:1;overflow-y:auto;
  padding:35vh 2.5rem 35vh;
  text-align:center;
  -webkit-mask-image:linear-gradient(to bottom,transparent 0%,#000 12%,#000 88%,transparent 100%);
  mask-image:linear-gradient(to bottom,transparent 0%,#000 12%,#000 88%,transparent 100%);
  scroll-behavior:smooth;
}
.lyrics-scroll::-webkit-scrollbar{width:0;display:none}

.lyric-line{
  padding:.625rem 0;cursor:default;-webkit-user-select:none;user-select:none;
  transition:all .6s var(--ease-out);
  opacity:.18;
  filter:blur(0px);
  transform:scale(.95);
}
.lyric-line:hover{opacity:.35}
.lyric-line p{
  transition:all .6s var(--ease-out);
  font-size:1rem;line-height:1.7;color:rgba(255,255,255,.8);font-weight:400;
}
.lyric-line .tlyric{font-size:.8125rem;color:var(--text-muted);margin-top:.2rem;font-weight:400}

.lyric-line.active{
  opacity:1;transform:scale(1);filter:blur(0);
}
.lyric-line.active p{
  font-size:1.5rem;font-weight:700;color:#fff;
  text-shadow:0 0 40px var(--primary-glow), 0 0 80px rgba(167,139,250,.1);
}
.lyric-line.active .tlyric{
  font-size:.875rem;color:var(--text-secondary);
  text-shadow:none;
}
.lyric-line.near{opacity:.35;transform:scale(.98);filter:blur(0)}
.lyric-line.near p{font-size:1.0625rem}
.lyric-line.far{opacity:.12;filter:blur(.5px);transform:scale(.92)}

.no-lyric{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;color:var(--text-dim);font-size:.9375rem;gap:.625rem;padding-bottom:20vh;
  font-weight:500;
}
.no-lyric svg{width:2rem;height:2rem;opacity:.3}

/* ===== Right Panel: Queue ===== */
.panel-right{
  height:100%;min-height:0;overflow:hidden;
  animation:panelSlideUp .7s .3s var(--ease-out) both;
}
.queue-wrapper{display:flex;flex-direction:column;height:100%;position:relative}
.queue-header{
  flex:0 0 auto;padding:.75rem 1rem;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.queue-header h3{
  font-weight:600;color:var(--text-secondary);
  display:flex;align-items:center;gap:.375rem;font-size:.8125rem;
}
.queue-header h3 svg{width:.875rem;height:.875rem;color:var(--primary)}
.queue-header .q-count{
  font-size:.6875rem;font-variant-numeric:tabular-nums;
  color:var(--text-muted);background:rgba(255,255,255,.04);
  padding:.2rem .4rem;border-radius:.25rem;font-weight:500;
}
.queue-list{flex:1;overflow-y:auto;min-height:0;padding:.25rem 0}
.queue-list::-webkit-scrollbar{width:3px}
.queue-list::-webkit-scrollbar-track{background:transparent}
.queue-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}
.queue-list::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.15)}

.queue-item{
  display:flex;align-items:center;gap:.5rem;
  padding:.5rem .75rem;transition:all .25s var(--ease-out);position:relative;
  margin:0 .25rem;border-radius:.625rem;
}
.queue-item:hover{background:rgba(255,255,255,.04)}
.queue-item.now-playing{
  background:linear-gradient(135deg,rgba(167,139,250,.08),rgba(167,139,250,.03));
  border:1px solid rgba(167,139,250,.1);
  margin-bottom:.125rem;
}
.q-drag{display:flex;align-items:center}
.q-drag svg{width:.875rem;height:.875rem;color:rgba(255,255,255,.08);transition:color .2s}
.queue-item:not(.now-playing) .q-drag svg{cursor:move}
.queue-item:not(.now-playing):hover .q-drag svg{color:var(--text-muted)}
.q-idx{width:1.25rem;text-align:center;font-size:.6875rem;font-weight:600;font-variant-numeric:tabular-nums;flex-shrink:0;color:var(--text-dim)}
.queue-item.now-playing .q-idx{color:var(--primary)}
.q-cover{width:2rem;height:2rem;border-radius:.375rem;object-fit:cover;flex-shrink:0;background:var(--surface)}
.q-info{flex:1;min-width:0}
.q-info .q-name{font-size:.8125rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:rgba(255,255,255,.85)}
.queue-item.now-playing .q-name{color:var(--primary-light);font-weight:600}
.q-info .q-artist{font-size:.6875rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.q-dur{width:2.5rem;text-align:right;font-size:.6875rem;color:var(--text-dim);font-variant-numeric:tabular-nums;flex-shrink:0}
.q-actions{
  position:absolute;right:2.5rem;top:50%;transform:translateY(-50%);
  display:flex;align-items:center;gap:.125rem;
  padding:.125rem .25rem;border-radius:.375rem;
  background:rgba(9,9,11,.95);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  border:1px solid var(--border);
  opacity:0;transition:opacity .2s;pointer-events:none;
}
.queue-item:not(.now-playing):hover .q-actions{opacity:1;pointer-events:auto}
.q-actions button{
  padding:.25rem;border-radius:.25rem;color:var(--text-muted);
  transition:all .15s var(--ease-out);
}
.q-actions button:hover{background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);transform:scale(1.1)}
.q-actions button.del:hover{background:rgba(248,113,113,.1);color:var(--red)}
.q-actions button svg{width:.75rem;height:.75rem}
.queue-empty{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;color:var(--text-dim);font-size:.8125rem;gap:.5rem;font-weight:500;
}
.queue-empty svg{width:1.75rem;height:1.75rem;opacity:.2}

/* Queue item entrance animation */
.queue-item.q-enter{animation:queueItemIn .4s var(--ease-out) both}
@keyframes queueItemIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}

/* ===== Responsive ===== */
@media(max-width:1100px){
  .main{
    grid-template-columns:1fr;grid-template-rows:auto 1fr auto;
    height:auto;min-height:calc(100vh - 49px);overflow-y:auto;gap:.75rem;padding:.75rem;
  }
  .panel-left{flex-direction:row;flex-wrap:wrap;gap:.75rem;height:auto}
  .player-card{flex:1 1 100%}
  .player-card .inner{flex-direction:row;gap:.75rem;align-items:flex-start}
  .album-art{width:110px;height:110px;aspect-ratio:auto;flex-shrink:0}
  .player-card .right-col{flex:1;min-width:0;display:flex;flex-direction:column;gap:.5rem}
  .controls-card{flex:1 1 100%}
  .panel-center{min-height:360px}
  .panel-right{min-height:180px;max-height:35vh}
}
@media(max-width:640px){
  .main{padding:.5rem;gap:.5rem}
  .header{padding:.5rem .75rem}
  .lyrics-scroll{padding:30vh 1.25rem}
  .lyric-line.active p{font-size:1.25rem}
  .lyric-line.near p{font-size:.9375rem}
}

/* ===== Toast ===== */
.toast{
  position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(1rem);z-index:100;
  padding:.5rem 1.25rem;border-radius:9999px;
  background:rgba(22,22,26,.95);border:1px solid var(--border);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  font-size:.8125rem;font-weight:500;color:var(--text);
  opacity:0;transition:all .35s var(--ease-spring);
  pointer-events:none;
  box-shadow:0 8px 32px rgba(0,0,0,.3);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.hide{opacity:0;transform:translateX(-50%) translateY(.75rem)}

/* ===== Search & Liked Modal ===== */
.search-overlay{
  position:fixed;inset:0;z-index:50;
  background:rgba(0,0,0,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  display:none;align-items:flex-start;justify-content:center;padding-top:8vh;
  opacity:0;transition:opacity .3s var(--ease-out);
}
.search-overlay.open{display:flex;animation:overlayIn .3s var(--ease-out) forwards}
@keyframes overlayIn{from{opacity:0}to{opacity:1}}
.search-modal{
  width:90%;max-width:540px;max-height:80vh;
  background:rgba(18,18,22,.98);border:1px solid var(--border-light);
  border-radius:var(--radius-xl);overflow:hidden;
  display:flex;flex-direction:column;
  box-shadow:0 24px 80px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.04);
  animation:modalIn .35s var(--ease-spring);
}
@keyframes modalIn{from{opacity:0;transform:translateY(-16px) scale(.96)}to{opacity:1;transform:none}}
.search-input-wrap{
  display:flex;align-items:center;gap:.75rem;
  padding:.875rem 1.25rem;border-bottom:1px solid var(--border);
}
.search-input-wrap svg{width:1.125rem;height:1.125rem;color:var(--text-muted);flex-shrink:0}
.search-input-wrap input{
  flex:1;background:none;border:none;outline:none;
  font-size:.9375rem;color:var(--text);caret-color:var(--primary);font-weight:500;
}
.search-input-wrap input::placeholder{color:var(--text-dim)}
.search-input-wrap .search-close{
  padding:.375rem;border-radius:.375rem;color:var(--text-muted);
  transition:all .15s var(--ease-out);flex-shrink:0;
}
.search-input-wrap .search-close:hover{background:rgba(255,255,255,.1);color:var(--text);transform:scale(1.05)}
.search-input-wrap .search-close svg{width:1rem;height:1rem}
.search-hint{padding:1.5rem 1.25rem;font-size:.8125rem;color:var(--text-dim);text-align:center;font-weight:500}
.search-results{flex:1;overflow-y:auto;padding:.25rem 0}
.search-results::-webkit-scrollbar{width:3px}
.search-results::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}
.search-item{
  display:flex;align-items:center;gap:.75rem;
  padding:.625rem 1.25rem;transition:all .2s var(--ease-out);cursor:pointer;
  border-radius:0;
}
.search-item:hover{background:rgba(255,255,255,.04)}
.search-item img{width:2.75rem;height:2.75rem;border-radius:.5rem;object-fit:cover;flex-shrink:0;background:var(--surface)}
.search-item .s-info{flex:1;min-width:0}
.search-item .s-name{font-size:.8125rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.search-item .s-meta{font-size:.6875rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:.125rem}
.search-item .s-dur{font-size:.6875rem;color:var(--text-dim);font-variant-numeric:tabular-nums;flex-shrink:0;margin-right:.25rem}
.search-item .s-add{
  flex-shrink:0;padding:.3rem .625rem;border-radius:9999px;
  font-size:.6875rem;font-weight:600;
  background:var(--primary-bg);color:var(--primary-light);border:1px solid var(--primary-border);
  transition:all .2s var(--ease-out);
}
.search-item .s-add:hover{background:rgba(167,139,250,.2);transform:scale(1.02)}
.search-item .s-add:active{transform:scale(.97)}
.search-item .s-add:disabled{opacity:.5;cursor:default;transform:none}
.search-item .s-add.added{background:rgba(74,222,128,.1);color:var(--green);border-color:rgba(74,222,128,.2)}
.search-loading,.search-empty{
  display:flex;align-items:center;justify-content:center;
  padding:2rem;color:var(--text-dim);font-size:.8125rem;gap:.5rem;font-weight:500;
}
.search-loading svg{width:1.125rem;height:1.125rem;animation:spin 1s linear infinite;color:var(--primary)}

/* ===== Liked Modal ===== */
#likedBody{flex:1;overflow-y:auto;min-height:0;position:relative}
#likedBody::-webkit-scrollbar{width:3px}
#likedBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}
#likedBody .search-results{animation:likedFadeIn .35s var(--ease-out)}
@keyframes likedFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
#likedBody .search-item{opacity:0;animation:likedItemIn .3s var(--ease-out) forwards}
@keyframes likedItemIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}

.liked-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:.875rem 1.25rem;border-bottom:1px solid var(--border);
}
.liked-header .liked-title{font-size:.9375rem;font-weight:600;display:flex;align-items:center;gap:.5rem}
.liked-header .liked-title svg{width:1rem;height:1rem;color:var(--primary)}
.liked-header .liked-stats{font-size:.6875rem;color:var(--text-muted)}
.liked-header-actions{display:flex;align-items:center;gap:.375rem}
.liked-header-actions button{
  padding:.375rem;border-radius:.375rem;color:var(--text-muted);
  transition:all .15s var(--ease-out);
}
.liked-header-actions button:hover{background:rgba(255,255,255,.1);color:var(--text);transform:scale(1.05)}
.liked-header-actions button svg{width:1rem;height:1rem}
.liked-pager{
  display:flex;align-items:center;justify-content:center;gap:.375rem;
  padding:.5rem 1.25rem;border-top:1px solid var(--border);
  background:rgba(18,18,22,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
}
.liked-pager button{
  padding:.3rem .5rem;border-radius:9999px;font-size:.6875rem;font-weight:600;
  background:rgba(255,255,255,.04);color:var(--text-muted);border:1px solid rgba(255,255,255,.06);
  transition:all .25s var(--ease-out);
  display:flex;align-items:center;gap:.2rem;
}
.liked-pager button svg{width:.625rem;height:.625rem;transition:transform .25s var(--ease-out)}
.liked-pager button:hover:not(:disabled){background:rgba(255,255,255,.1);color:var(--text);border-color:rgba(255,255,255,.12)}
.liked-pager button:hover:not(:disabled) svg{transform:translateX(-1px)}
.liked-pager button:last-of-type:hover:not(:disabled) svg{transform:translateX(1px)}
.liked-pager button:active:not(:disabled){transform:scale(.95)}
.liked-pager button:disabled{opacity:.2}
.liked-pager span{font-size:.625rem;color:var(--text-dim);min-width:4rem;text-align:center;font-variant-numeric:tabular-nums}
</style>
</head>
<body>

<!-- Ambient Background -->
<div class="ambient" id="ambient">
  <img id="ambientImg" src="" alt="">
  <div class="overlay"></div>
</div>

<!-- Header -->
<header class="header">
  <div class="header-left">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.1 19.1 19"/></svg>
    <h1>Oopz Music</h1>
    <span>音乐</span>
  </div>
  <div class="header-right">
    <div class="conn-status ok" id="connStatus">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 13a10 10 0 0 1 14 0"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M2 8.82a15 15 0 0 1 20 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
      <span>已连接</span>
    </div>
    <button class="header-btn" title="喜欢的音乐" id="btnOpenLiked" onclick="openLiked()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
    </button>
    <button class="header-btn" title="搜索点歌" id="btnOpenSearch" onclick="openSearch()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
    </button>
    <button class="header-btn" title="刷新" onclick="location.reload()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
    </button>
  </div>
</header>

<!-- Main Content -->
<main class="main">

  <!-- Left Panel -->
  <div class="panel-left" id="panelLeft">
    <!-- Player Card -->
    <div class="player-card" id="playerCard">
      <div class="inner">
        <div id="playerActive" style="display:none">
          <!-- Album Art -->
          <div class="album-art" id="albumArt">
            <img id="cover" src="" alt="">
            <div class="playing-badge" id="playingBadge">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M6 12c0-1.7.7-3.2 1.8-4.2"/><circle cx="12" cy="12" r="2"/><path d="M18 12c0 1.7-.7 3.2-1.8 4.2"/></svg>
              <span>Playing</span>
            </div>
          </div>

          <!-- Song Info -->
          <div class="song-info" id="songInfoWrap">
            <h1 id="songName"></h1>
            <p class="artist" id="songArtist"></p>
            <p class="album-name" id="songAlbum"></p>
          </div>

          <!-- Platform Badge -->
          <div class="platform-row" id="platformRow">
            <span class="platform-badge" id="platformTag">NETEASE</span>
            <span class="mode-badge" id="modeTag">顺序播放</span>
          </div>

          <!-- Progress -->
          <div class="progress-wrap">
            <div class="progress-track" id="progressTrack">
              <div class="rail"><div class="fill" id="progressFill" style="width:0"></div></div>
              <div class="thumb" id="progressThumb" style="left:0"></div>
            </div>
            <div class="progress-time">
              <span id="timeCur">0:00</span>
              <span id="timeTotal">0:00</span>
            </div>
          </div>

          <!-- Volume -->
          <div class="volume-row">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
            <div class="volume-track" id="volumeTrack">
              <div class="rail"><div class="fill" id="volumeFill" style="width:50%"></div></div>
              <div class="thumb" id="volumeThumb" style="left:50%"></div>
            </div>
            <span class="volume-pct" id="volumePct">50%</span>
          </div>
        </div>

        <!-- Idle State -->
        <div class="idle-state" id="playerIdle">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M6 12c0-1.7.7-3.2 1.8-4.2"/><circle cx="12" cy="12" r="2"/><path d="M18 12c0 1.7-.7 3.2-1.8 4.2"/></svg>
          <p>等待播放...</p>
        </div>
      </div>
    </div>

    <!-- Controls Card -->
    <div class="controls-card glass-panel">
      <div class="controls-grid">
        <button class="ctrl-btn" title="上一首" id="btnPrev" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg>
          <span>上一首</span>
        </button>
        <button class="ctrl-btn" title="暂停" id="btnPause" onclick="togglePause()">
          <svg id="iconPause" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
          <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          <span id="pauseLabel">暂停</span>
        </button>
        <button class="ctrl-btn" title="下一首" id="btnNext" onclick="doControl('next')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
          <span>下一首</span>
        </button>
        <button class="ctrl-btn danger" title="清空队列" id="btnClear" onclick="doControl('clear')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
          <span>清空</span>
        </button>
        <button class="ctrl-btn mode" title="顺序播放" id="btnMode" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
          <span>顺序播放</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Center Panel: Lyrics -->
  <div class="panel-center glass-panel">
    <div class="lyrics-container">
      <!-- Toggle Buttons -->
      <div class="lyrics-controls" id="lyricsControls" style="display:none">
        <div style="position:relative">
          <button class="lyric-toggle" id="btnSync" title="歌词同步调节">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span id="btnSyncLabel">同步</span>
          </button>
          <div class="lyric-sync-popover" id="lyricSyncPopover">
            <span>偏移：</span>
            <button type="button" data-delta="-1">-1s</button>
            <button type="button" data-delta="-0.5">-0.5s</button>
            <button type="button" data-delta="0.5">+0.5s</button>
            <button type="button" data-delta="1">+1s</button>
            <button type="button" data-reset>重置</button>
            <span id="lyricSyncValue">0s</span>
          </div>
        </div>
        <button class="lyric-toggle" id="btnTrans" title="显示翻译">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
          译
        </button>
      </div>

      <!-- Lyrics -->
      <div class="lyrics-scroll" id="lyricsScroll">
        <div class="no-lyric" id="noLyric">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M6 12c0-1.7.7-3.2 1.8-4.2"/><circle cx="12" cy="12" r="2"/><path d="M18 12c0 1.7-.7 3.2-1.8 4.2"/></svg>
          暂无歌词
        </div>
      </div>
    </div>
  </div>

  <!-- Right Panel: Queue -->
  <div class="panel-right glass-panel">
    <div class="queue-wrapper">
      <div class="queue-header">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15V6"/><path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M12 12H3"/><path d="M16 6H3"/><path d="M12 18H3"/></svg>
          播放队列
        </h3>
        <span class="q-count" id="queueCount">0 首</span>
      </div>
      <div class="queue-list" id="queueList">
        <div class="queue-empty" id="queueEmpty">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15V6"/><path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M12 12H3"/><path d="M16 6H3"/><path d="M12 18H3"/></svg>
          队列为空
        </div>
      </div>
    </div>
  </div>

</main>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Liked Modal -->
<div class="search-overlay" id="likedOverlay" onclick="if(event.target===this)closeLiked()">
  <div class="search-modal">
    <div class="liked-header">
      <div class="liked-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
        喜欢的音乐
        <span class="liked-stats" id="likedStats"></span>
      </div>
      <div class="liked-header-actions">
        <button title="刷新列表" onclick="refreshLiked()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        </button>
        <button class="search-close" onclick="closeLiked()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
    </div>
    <div class="search-input-wrap" style="border-bottom:1px solid var(--border);padding:.5rem 1rem">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" id="likedSearchInput" placeholder="在全部喜欢中搜索歌曲、歌手、专辑..." autocomplete="off" spellcheck="false">
    </div>
    <div id="likedBody">
      <div class="search-loading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        加载中...</div>
    </div>
    <div class="liked-pager" id="likedPager" style="display:none">
      <button id="likedPrev"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>上一页</button>
      <span id="likedPageInfo"></span>
      <button id="likedNext">下一页<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
    </div>
  </div>
</div>

<!-- Search Modal -->
<div class="search-overlay" id="searchOverlay" onclick="if(event.target===this)closeSearch()">
  <div class="search-modal">
    <div class="search-input-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" id="searchInput" placeholder="搜索歌曲、歌手..." autocomplete="off" spellcheck="false">
      <button class="search-close" onclick="closeSearch()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div id="searchBody">
      <div class="search-hint">输入关键词搜索音乐</div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);

  let currentId = null;
  let lyrics = [];
  let tLyrics = [];
  let activeLine = -1;
  let volume = Math.min(100, Math.max(0, parseInt(localStorage.getItem('webVolume'), 10) || 50));
  let showTrans = false;
  let apiOk = true;
  let lastStatusError = 0;
  let isPaused = false;
  let currentDuration = 0;
  let isSeeking = false;
  let volumeDebounce = null;
  let _savedVolumeApplied = false;
  /** 上次从服务端拿到的进度（秒）及收到时的时间戳，用于本地插值，使歌词与进度条在轮询间隔内平滑更新 */
  let _progressBase = 0;
  let _progressBaseTime = 0;
  /** 歌词整体偏移（秒），用于手动微调不同步；持久化到 localStorage */
  let lyricOffsetSec = parseFloat(localStorage.getItem('lyricOffset')) || 0;

  function fmtTime(sec){
    if(!sec||sec<0) sec=0;
    const m=Math.floor(sec/60), s=Math.floor(sec%60);
    return m+':'+(s<10?'0':'')+s;
  }

  function toast(msg, dur){
    const el=$('toast');
    el.textContent=msg;
    el.className='toast show';
    clearTimeout(el._t);
    el._t=setTimeout(()=>el.className='toast hide', dur||2500);
  }

  function parseLRC(lrc){
    if(!lrc) return [];
    const lines=[], re=/\[(\d{1,3}):(\d{2})(?:\.(\d{1,3}))?\]/g;
    for(const raw of lrc.split('\n')){
      let match; const times=[];
      while((match=re.exec(raw))!==null){
        const min=parseInt(match[1]), sec=parseInt(match[2]);
        const ms=match[3]?parseInt(match[3].padEnd(3,'0')):0;
        times.push(min*60+sec+ms/1000);
      }
      const text=raw.replace(/\[.*?\]/g,'').trim();
      if(text) for(const t of times) lines.push({time:t,text});
    }
    lines.sort((a,b)=>a.time-b.time);
    return lines;
  }

  function renderLyrics(){
    const el=$('lyricsScroll');
    if(!lyrics.length){
      el.innerHTML=`<div class="no-lyric">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M6 12c0-1.7.7-3.2 1.8-4.2"/><circle cx="12" cy="12" r="2"/><path d="M18 12c0 1.7-.7 3.2-1.8 4.2"/></svg>
        暂无歌词</div>`;
      return;
    }
    el.innerHTML=lyrics.map((l,i)=>{
      let html=`<div class="lyric-line" data-idx="${i}"><p>${esc(l.text)}</p>`;
      if(showTrans && tLyrics.length){
        const tl = tLyrics.find(t=>Math.abs(t.time-l.time)<0.5);
        if(tl) html+=`<p class="tlyric">${esc(tl.text)}</p>`;
      }
      html+=`</div>`;
      return html;
    }).join('');
    activeLine=-1;
  }

  function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

  /** 用当前进度更新进度条、当前时间、歌词高亮（progress 为秒，已含偏移在外部加） */
  function updateProgressUI(progress){
    const sec = Math.max(0, Math.min(progress, currentDuration));
    if(currentDuration>0){
      const pct=Math.min(sec/currentDuration*100,100);
      $('progressFill').style.width=pct+'%';
      $('progressThumb').style.left=pct+'%';
    }
    $('timeCur').textContent=fmtTime(sec);
    highlightLyric(sec);
  }

  function highlightLyric(progress){
    if(!lyrics.length) return;
    const t = progress + lyricOffsetSec;
    let idx=-1;
    for(let i=lyrics.length-1;i>=0;i--){
      if(t>=lyrics[i].time){idx=i;break;}
    }
    if(idx===activeLine) return;
    activeLine=idx;
    const el=$('lyricsScroll');
    const lines=el.querySelectorAll('.lyric-line');
    lines.forEach((ln,i)=>{
      ln.classList.remove('active','near','far');
      if(i===idx) ln.classList.add('active');
      else if(Math.abs(i-idx)<=2) ln.classList.add('near');
      else if(Math.abs(i-idx)>5) ln.classList.add('far');
    });
    if(idx>=0&&lines[idx]){
      const container=el;
      const lineEl=lines[idx];
      const top=lineEl.offsetTop-container.clientHeight/2+lineEl.clientHeight/2;
      container.scrollTo({top:Math.max(0,top),behavior:'smooth'});
    }
  }

  function setConnStatus(ok){
    if(ok===apiOk) return;
    apiOk=ok;
    const el=$('connStatus');
    el.className='conn-status '+(ok?'ok':'err');
    el.querySelector('span').textContent=ok?'已连接':'连接断开';
  }

  /* Song change animation helper */
  function triggerSongChangeAnimation(){
    const art=$('albumArt');
    const coverImg=$('cover');
    const infoWrap=$('songInfoWrap');

    art.classList.add('has-glow');
    coverImg.classList.remove('art-enter');
    void coverImg.offsetWidth;
    coverImg.classList.add('art-enter');

    infoWrap.classList.remove('song-enter');
    void infoWrap.offsetWidth;
    infoWrap.classList.add('song-enter');

    $('ambient').classList.add('visible');
  }

  async function fetchStatus(){
    try{
      const r=await fetch('/api/status');
      const d=await r.json();
      setConnStatus(true);

      _lastStatus=d;

      if(!d.playing){
        if(currentId!==null){
          currentId=null;lyrics=[];tLyrics=[];activeLine=-1;
          $('playerActive').style.display='none';
          $('playerIdle').style.display='';
          $('ambientImg').src='';
          $('ambient').classList.remove('visible');
          $('lyricsControls').style.display='none';
          const art=$('albumArt');
          if(art) art.classList.remove('has-glow');
          renderLyrics();
        }
        return;
      }

      if(d.id!==currentId){
        currentId=d.id;
        $('playerActive').style.display='';
        $('playerIdle').style.display='none';
        $('songName').textContent=d.name||'';
        $('songName').title=d.name||'';
        $('songArtist').textContent=d.artists||'';
        $('songAlbum').textContent=d.album||'';
        $('cover').src=d.cover||'';
        $('ambientImg').src=d.cover||'';
        $('timeTotal').textContent=d.durationText||fmtTime(d.duration);
        $('lyricsControls').style.display='flex';
        activeLine=-1;
        triggerSongChangeAnimation();
        fetchLyric(d.id);
      }

      currentDuration=d.duration||0;

      isPaused=!!d.paused;
      $('iconPause').style.display=isPaused?'none':'';
      $('iconPlay').style.display=isPaused?'':'none';
      $('pauseLabel').textContent=isPaused?'播放':'暂停';
      const badge=$('playingBadge');
      badge.querySelector('span').textContent=isPaused?'Paused':'Playing';
      badge.classList.toggle('paused',isPaused);

      if(d.volume!==undefined && !volumeDebounce){
        if(!_savedVolumeApplied){
          _savedVolumeApplied=true;
          const saved=Math.min(100,Math.max(0,parseInt(localStorage.getItem('webVolume'),10)||50));
          volume=saved;
          $('volumeFill').style.width=volume+'%';
          $('volumeThumb').style.left=volume+'%';
          $('volumePct').textContent=volume+'%';
          fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'volume',value:volume})});
        }else{
          volume=d.volume;
          $('volumeFill').style.width=volume+'%';
          $('volumeThumb').style.left=volume+'%';
          $('volumePct').textContent=volume+'%';
        }
      }

      _progressBase = d.progress;
      _progressBaseTime = Date.now();
      if(!isSeeking){
        if(isPaused){
          updateProgressUI(d.progress);
        }else{
          updateProgressUI(d.progress);
        }
      }
    }catch(e){
      const now=Date.now();
      if(now-lastStatusError>5000){
        lastStatusError=now;
        setConnStatus(false);
      }
    }
  }

  async function fetchLyric(id){
    try{
      const r=await fetch('/api/lyric?id='+id);
      const d=await r.json();
      lyrics=parseLRC(d.lyric);
      tLyrics=parseLRC(d.tlyric);
      renderLyrics();
    }catch(e){lyrics=[];tLyrics=[];renderLyrics();}
  }

  let _lastStatus = null;
  /** 上次渲染的队列 id 列表，用于避免无变化时重绘导致闪烁 */
  let _lastQueueKey = null;

  async function fetchQueue(){
    try{
      const r=await fetch('/api/queue');
      const d=await r.json();
      const el=$('queueList');
      const waitQueue=d.queue||[];

      const fullQueue=[];
      if(_lastStatus && _lastStatus.playing){
        fullQueue.push({
          id:_lastStatus.id,name:_lastStatus.name,artists:_lastStatus.artists,
          cover:_lastStatus.cover,durationText:_lastStatus.durationText,_current:true
        });
      }
      for(const s of waitQueue) fullQueue.push(s);

      /* 生成当前队列的“指纹”，无变化则不再重绘 */
      const queueKey = fullQueue.length + '-' + fullQueue.map(s=>s.id).join(',');
      if(queueKey === _lastQueueKey){
        $('queueCount').textContent=fullQueue.length+' 首';
        return;
      }
      const wasEmpty = !_lastQueueKey || _lastQueueKey === '0-';
      _lastQueueKey = queueKey;

      $('queueCount').textContent=fullQueue.length+' 首';

      if(!fullQueue.length){
        el.innerHTML=`<div class="queue-empty">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15V6"/><path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M12 12H3"/><path d="M16 6H3"/><path d="M12 18H3"/></svg>
          队列为空</div>`;
        return;
      }

      const hasCurrent=fullQueue.length>0&&fullQueue[0]._current;
      /* 仅当从空变为有列表时播放一次入场动画 */
      const animateEnter = wasEmpty;
      el.innerHTML=fullQueue.map((s,i)=>{
        const isCurrent=!!s._current;
        const redisIdx=hasCurrent?i-1:i;
        const enterClass = animateEnter ? ' q-enter' : '';
        const enterStyle = animateEnter ? ` style="animation-delay:${i*40}ms"` : '';
        return `<div class="queue-item${enterClass}${isCurrent?' now-playing':''}" data-idx="${i}"${enterStyle}>
          <div class="q-drag"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>
          <span class="q-idx">${i+1}</span>
          <img class="q-cover" src="${esc(s.cover||'')}" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
          <div class="q-info">
            <div class="q-name">${esc(s.name||'')}</div>
            <div class="q-artist">${esc(s.artists||'')}</div>
          </div>
          <span class="q-dur">${s.durationText||''}</span>
          ${!isCurrent?`<div class="q-actions">
            <button title="置顶" onclick="doQueueAction('top',${redisIdx})"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3h14"/><path d="m18 13-6-6-6 6"/><path d="M12 7v14"/></svg></button>
            <button class="del" title="删除" onclick="doQueueAction('remove',${redisIdx})"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
          </div>`:''}
        </div>`;
      }).join('');
    }catch(e){}
  }

  window.doControl=async function(action){
    try{
      const r=await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action})});
      const d=await r.json();
      if(d.ok){
        toast({next:'已切换下一首',clear:'队列已清空',stop:'已停止播放',pause:'已暂停',resume:'继续播放'}[action]||'操作成功');
        setTimeout(()=>{fetchStatus();fetchQueue()},500);
      }else{
        toast(d.error||'操作失败');
      }
    }catch(e){toast('操作失败：网络错误');}
  };

  window.doQueueAction=async function(action,idx){
    try{
      const r=await fetch('/api/queue/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,index:idx})});
      const d=await r.json();
      if(d.ok){
        toast({top:'已置顶',remove:'已删除'}[action]||'操作成功');
        fetchQueue();
      }else{toast(d.error||'操作失败');}
    }catch(e){toast('操作失败');}
  };

  function applyLyricOffset(offset){
    lyricOffsetSec = Math.round(offset * 10) / 10;
    if(lyricOffsetSec === 0) lyricOffsetSec = 0;
    localStorage.setItem('lyricOffset', String(lyricOffsetSec));
    $('lyricSyncValue').textContent = (lyricOffsetSec >= 0 ? '+' : '') + lyricOffsetSec + 's';
    $('btnSync').classList.toggle('active', lyricOffsetSec !== 0);
    $('btnSyncLabel').textContent = lyricOffsetSec === 0 ? '同步' : (lyricOffsetSec > 0 ? '+' : '') + lyricOffsetSec + 's';
    if(currentId && !isPaused && currentDuration){
      const localProgress = _progressBase + (Date.now() - _progressBaseTime)/1000;
      highlightLyric(Math.min(localProgress, currentDuration));
    }
  }
  function initLyricSyncUI(){
    $('lyricSyncValue').textContent = (lyricOffsetSec >= 0 ? '+' : '') + lyricOffsetSec + 's';
    $('btnSync').classList.toggle('active', lyricOffsetSec !== 0);
    $('btnSyncLabel').textContent = lyricOffsetSec === 0 ? '同步' : (lyricOffsetSec > 0 ? '+' : '') + lyricOffsetSec + 's';
  }
  $('btnSync').addEventListener('click',function(e){
    e.stopPropagation();
    const pop=$('lyricSyncPopover');
    pop.classList.toggle('open');
  });
  $('lyricSyncPopover').addEventListener('click',function(e){
    e.stopPropagation();
    const btn=e.target.closest('button');
    if(!btn) return;
    if(btn.dataset.reset){
      applyLyricOffset(0);
      toast('歌词偏移已重置');
      return;
    }
    const delta=parseFloat(btn.dataset.delta);
    if(!isNaN(delta)){
      applyLyricOffset(lyricOffsetSec + delta);
      toast('歌词已' + (delta > 0 ? '延后' : '提前') + ' ' + Math.abs(delta) + ' 秒');
    }
  });
  document.addEventListener('click',function(){
    $('lyricSyncPopover').classList.remove('open');
  });
  initLyricSyncUI();

  $('btnTrans').addEventListener('click',function(){
    showTrans=!showTrans;
    this.classList.toggle('active',showTrans);
    renderLyrics();
  });

  window.togglePause=function(){
    if(!currentId) return;
    const action=isPaused?'resume':'pause';
    isPaused=!isPaused;
    $('iconPause').style.display=isPaused?'none':'';
    $('iconPlay').style.display=isPaused?'':'none';
    $('pauseLabel').textContent=isPaused?'播放':'暂停';
    const badge=$('playingBadge');
    badge.querySelector('span').textContent=isPaused?'Paused':'Playing';
    badge.classList.toggle('paused',isPaused);
    fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action})})
      .then(r=>r.json()).then(d=>{if(d.ok)toast(action==='pause'?'已暂停':'继续播放')})
      .catch(()=>{});
  };

  (function(){
    const track=$('progressTrack');
    let dragging=false;
    function seekTo(e){
      if(!currentDuration) return;
      const rect=track.getBoundingClientRect();
      const pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
      const seekTime=pct*currentDuration;
      $('progressFill').style.width=(pct*100)+'%';
      $('progressThumb').style.left=(pct*100)+'%';
      $('timeCur').textContent=fmtTime(seekTime);
      return seekTime;
    }
    track.addEventListener('mousedown',e=>{
      isSeeking=true;dragging=true;seekTo(e);
    });
    document.addEventListener('mousemove',e=>{
      if(dragging) seekTo(e);
    });
    document.addEventListener('mouseup',e=>{
      if(dragging){
        dragging=false;
        const t=seekTo(e);
        if(t!==undefined){
          _progressBase=t;
          _progressBaseTime=Date.now();
          fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'seek',time:Math.round(t)})});
          highlightLyric(t);
        }
        setTimeout(()=>{isSeeking=false},300);
      }
    });
  })();

  (function(){
    const track=$('volumeTrack');
    let dragging=false;
    function setVol(e){
      const rect=track.getBoundingClientRect();
      let pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
      volume=Math.round(pct*100);
      $('volumeFill').style.width=volume+'%';
      $('volumeThumb').style.left=volume+'%';
      $('volumePct').textContent=volume+'%';
    }
    function sendVolume(){
      clearTimeout(volumeDebounce);
      localStorage.setItem('webVolume', String(volume));
      volumeDebounce=setTimeout(()=>{
        fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'volume',value:volume})});
        setTimeout(()=>{volumeDebounce=null},1000);
      },200);
    }
    track.addEventListener('mousedown',e=>{dragging=true;setVol(e)});
    document.addEventListener('mousemove',e=>{if(dragging)setVol(e)});
    document.addEventListener('mouseup',()=>{if(dragging){dragging=false;sendVolume()}});
  })();

  let _addedIds=new Set();

  let _likedPage=1;
  let _likedPages=1;
  let _likedSearchKeyword = '';

  function renderLikedList(songsToShow){
    const body=$('likedBody');
    if(!songsToShow.length){
      body.innerHTML='<div class="search-empty">'+(_likedSearchKeyword?'未找到匹配的歌曲':'喜欢列表为空')+'</div>';
      body.style.opacity='1';body.style.transform='';
      return;
    }
    body.innerHTML='<div class="search-results">'+songsToShow.filter(s=>s&&s.id).map((s,i)=>`
      <div class="search-item" data-id="${s.id}" style="animation-delay:${i*25}ms">
        <img src="${esc(s.cover||'')}" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
        <div class="s-info">
          <div class="s-name">${esc(s.name||'未知歌曲')}</div>
          <div class="s-meta">${esc(s.artists||'未知')} · ${esc(s.album||'')}</div>
        </div>
        <span class="s-dur">${s.durationText||''}</span>
        <button class="s-add${_addedIds.has(s.id)?' added':''}" onclick="addSong(this,${JSON.stringify(s).replace(/"/g,'&quot;')})" title="加入播放队列">${_addedIds.has(s.id)?'已在队列':'加入队列'}</button>
      </div>
    `).join('')+'</div>';
    body.scrollTop=0;
  }

  window.openLiked=function(){
    _likedSearchKeyword='';
    $('likedSearchInput').value='';
    $('likedOverlay').classList.add('open');
    loadLiked(1);
  };
  window.closeLiked=function(){
    $('likedOverlay').classList.remove('open');
  };
  window.refreshLiked=async function(){
    $('likedBody').innerHTML='<div class="search-loading"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-6.219-8.56"/></svg>刷新中...</div>';
    $('likedPager').style.display='none';
    try{ await fetch('/api/liked/refresh',{method:'POST'}); }catch(e){}
    _likedSearchKeyword='';
    $('likedSearchInput').value='';
    loadLiked(1);
  };
  window.loadLiked=async function(page){
    if(page<1) page=1;
    const body=$('likedBody');
    const kw=_likedSearchKeyword.trim();
    const url='/api/liked?page='+page+'&limit=30'+(kw?'&keyword='+encodeURIComponent(kw):'');

    body.style.transition='opacity .15s ease-out, transform .15s ease-out';
    body.style.opacity='0';
    body.style.transform='translateY(4px)';

    await new Promise(r=>setTimeout(r,160));

    try{
      const r=await fetch(url);
      const d=await r.json();
      if(d.error){
        body.innerHTML='<div class="search-empty">'+esc(d.error)+'</div>';
        $('likedPager').style.display='none';
        body.style.opacity='1';body.style.transform='';
        return;
      }
      const songs=d.songs||[];
      _likedPage=d.page||1;
      _likedPages=d.pages||1;
      $('likedStats').textContent=kw ? '共 '+d.total+' 条结果' : '('+d.total+' 首)';
      if(!songs.length){
        body.innerHTML='<div class="search-empty">'+(kw?'未找到匹配的歌曲':'喜欢列表为空')+'</div>';
        $('likedPager').style.display='none';
        body.style.opacity='1';body.style.transform='';
        return;
      }
      renderLikedList(songs);
      requestAnimationFrame(()=>{
        body.style.transition='opacity .3s cubic-bezier(.2,.6,.35,1), transform .3s cubic-bezier(.2,.6,.35,1)';
        body.style.opacity='1';
        body.style.transform='translateY(0)';
      });
      $('likedPager').style.display='flex';
      $('likedPrev').disabled=(_likedPage<=1);
      $('likedNext').disabled=(_likedPage>=_likedPages);
      $('likedPageInfo').textContent=_likedPage+' / '+_likedPages;
    }catch(e){
      console.error('liked load error:',e);
      body.innerHTML='<div class="search-empty">加载失败: '+(e.message||'请重试')+'</div>';
      body.style.opacity='1';body.style.transform='';
    }
  };

  let _likedSearchTimer=null;
  $('likedSearchInput').addEventListener('input',function(){
    _likedSearchKeyword=this.value.trim();
    clearTimeout(_likedSearchTimer);
    _likedSearchTimer=setTimeout(()=>loadLiked(1), 320);
  });
  $('likedSearchInput').addEventListener('keydown',function(e){ if(e.key==='Escape') this.blur(); });

  $('likedPrev').addEventListener('click',function(){ loadLiked(_likedPage-1); });
  $('likedNext').addEventListener('click',function(){ loadLiked(_likedPage+1); });

  document.addEventListener('keydown',function(e){
    if(e.key==='Escape'&&$('likedOverlay').classList.contains('open')) closeLiked();
  });

  let _searchTimer=null;

  window.openSearch=function(){
    $('searchOverlay').classList.add('open');
    setTimeout(()=>$('searchInput').focus(),100);
  };
  window.closeSearch=function(){
    $('searchOverlay').classList.remove('open');
    $('searchInput').value='';
    $('searchBody').innerHTML='<div class="search-hint">输入关键词搜索音乐</div>';
  };

  $('searchInput').addEventListener('input',function(){
    clearTimeout(_searchTimer);
    const kw=this.value.trim();
    if(!kw){
      $('searchBody').innerHTML='<div class="search-hint">输入关键词搜索音乐</div>';
      return;
    }
    $('searchBody').innerHTML=`<div class="search-loading">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
      搜索中...</div>`;
    _searchTimer=setTimeout(()=>doSearch(kw),400);
  });

  $('searchInput').addEventListener('keydown',function(e){
    if(e.key==='Escape') closeSearch();
  });

  document.addEventListener('keydown',function(e){
    if(e.key==='Escape'&&$('searchOverlay').classList.contains('open')) closeSearch();
  });

  async function doSearch(kw){
    try{
      const r=await fetch('/api/search?keyword='+encodeURIComponent(kw));
      const d=await r.json();
      const results=d.results||[];
      if(!results.length){
        $('searchBody').innerHTML='<div class="search-empty">未找到相关歌曲</div>';
        return;
      }
      $('searchBody').innerHTML='<div class="search-results">'+results.filter(s=>s&&s.id).map(s=>`
        <div class="search-item" data-id="${s.id}">
          <img src="${esc(s.cover||'')}" alt="" loading="lazy" onerror="this.style.visibility='hidden'">
          <div class="s-info">
            <div class="s-name">${esc(s.name||'未知歌曲')}</div>
            <div class="s-meta">${esc(s.artists||'未知')} · ${esc(s.album||'')}</div>
          </div>
          <span class="s-dur">${s.durationText||''}</span>
          <button class="s-add${_addedIds.has(s.id)?' added':''}" onclick="addSong(this,${JSON.stringify(s).replace(/"/g,'&quot;')})" title="加入播放队列">${_addedIds.has(s.id)?'已在队列':'加入队列'}</button>
        </div>
      `).join('')+'</div>';
    }catch(e){
      $('searchBody').innerHTML='<div class="search-empty">搜索失败，请重试</div>';
    }
  }

  window.addSong=async function(btn,song){
    if(btn.disabled) return;
    btn.disabled=true;
    btn.textContent='添加中...';
    try{
      const r=await fetch('/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(song)});
      const d=await r.json();
      if(d.ok){
        btn.textContent='已添加';
        btn.classList.add('added');
        _addedIds.add(song.id);
        toast(`已添加「${song.name}」到队列`);
        fetchQueue();
      }else{
        btn.textContent='失败';
        toast(d.error||'添加失败');
        setTimeout(()=>{btn.textContent='添加';btn.disabled=false},1500);
      }
    }catch(e){
      btn.textContent='添加';
      btn.disabled=false;
      toast('添加失败：网络错误');
    }
  };

  /** 进度/歌词平滑：在两次 status 轮询之间用本地时间插值，避免歌词只按 1 秒跳变 */
  function tickProgress(){
    if(!currentId||isPaused||isSeeking||!currentDuration) return;
    const localProgress = _progressBase + (Date.now() - _progressBaseTime)/1000;
    updateProgressUI(Math.min(localProgress, currentDuration));
  }
  setInterval(tickProgress, 150);

  fetchStatus();
  fetchQueue();
  setInterval(fetchStatus,1000);
  setInterval(fetchQueue,5000);
})();
</script>
</body>
</html>

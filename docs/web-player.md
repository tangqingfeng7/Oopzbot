# Web 播放器说明

Web 播放器是一个独立的歌词与播放控制页面，与 Bot 播放状态通过 Redis 同步，支持歌词滚动、播放队列、喜欢列表、搜索点歌、暂停/切歌/音量等。

---

## 功能概览

| 功能 | 说明 |
|------|------|
| **播放状态** | 当前歌曲、封面、进度条、暂停/播放、与 Bot 实时同步 |
| **歌词** | 自动加载歌词与翻译，高亮当前行；支持**歌词同步**（本地插值 + 手动偏移） |
| **播放队列** | 展示当前 + 待播列表，支持置顶、删除；**防闪烁**（仅数据变化时重绘） |
| **喜欢列表** | 分页浏览网易云喜欢列表；支持**全量搜索**（在全部喜欢中按歌名/歌手/专辑搜索后分页） |
| **搜索点歌** | 关键词搜索歌曲，一键加入队列 |
| **音量** | 滑块调节音量并下发到 Bot；**记忆上次音量**（localStorage 持久化，下次打开恢复） |

---

## 歌词同步

- **本地插值**：进度与歌词高亮按约 150ms 间隔用本地时间插值，避免仅靠 1 秒轮询导致的卡顿与不同步。
- **手动偏移**：点击「同步」可设置歌词整体提前/延后（-1s、-0.5s、+0.5s、+1s、重置），偏移写入 `localStorage`（键 `lyricOffset`），刷新后保留。

---

## 音量记忆

- 调节音量后会写入 `localStorage`（键 `webVolume`）。
- 再次打开或刷新页面时，会优先用本地保存的音量更新界面并下发到 Bot，与上次使用保持一致。

---

## 喜欢列表搜索

- 在「喜欢的音乐」弹层中的搜索框输入关键词，会在**全部喜欢**中搜索（不限于当前页）。
- 后端会拉取全部喜欢歌曲详情，按歌名、歌手、专辑过滤后再分页返回；分页为「搜索结果」的分页。
- 清空搜索框即恢复为普通分页浏览全部喜欢。

---

## 配置

在 `config.py` 的 `WEB_PLAYER_CONFIG` 中设置：

| 配置项 | 说明 |
|--------|------|
| `host` | 监听地址，默认 `0.0.0.0` |
| `port` | 监听端口，默认 `8080`（或与 README 中 3001 等保持一致，以实际为准） |
| `url` | 对外展示的访问地址，留空则自动检测 |

---

## HTTP API

以下为 Web 播放器服务（`web_player.py`）提供的接口，根路径为 `http://<host>:<port>`。

### 播放状态

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/status` | 当前播放状态：`playing`、`paused`、歌曲信息、`progress`（秒）、`duration`、`volume` 等 |

无播放时返回 `{"playing": false}`。

---

### 歌词

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/lyric?id=<song_id>` | 获取指定歌曲的歌词与翻译歌词（LRC），返回 `lyric`、`tlyric` |

---

### 队列

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/queue` | 播放队列，返回 `queue` 数组，每项含 `id`、`name`、`artists`、`cover`、`durationText` |
| POST | `/api/queue/action` | 队列操作。Body: `{"action":"remove"|"top","index":<0-based>}` |

---

### 喜欢列表

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/liked?page=<n>&limit=<n>[&keyword=<kw>]` | 喜欢的音乐。`page`、`limit` 分页；可选 `keyword` 时在**全部喜欢**中搜索后分页返回 |
| POST | `/api/liked/refresh` | 刷新喜欢列表缓存（清空后下次请求重新拉取） |

---

### 搜索与点歌

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/search?keyword=<kw>&limit=<n>` | 搜索歌曲，返回 `results` 数组 |
| POST | `/api/add` | 添加歌曲到队列。Body: `{"id", "name", "artists", "album", "cover", "duration", "durationText"}` |

---

### 播放控制

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/control` | 控制播放。Body: `{"action":"next"|"stop"|"pause"|"resume"}` 或 `{"action":"seek","time":<秒>}` 或 `{"action":"volume","value":<0-100>}` |

---

### 页面

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/` | 返回 Web 播放器前端页面（`player.html`） |

---

## 相关文档

- [系统架构](architecture.md) — Web 播放器与 Redis、music 模块的协作及 Redis 键、Web 命令格式
- [配置说明](configuration.md) — `WEB_PLAYER_CONFIG` 等配置项
